//==============================================================================
// Project	   : uORF
// Name        : uORF__compile.h
// Author      : Garin Newcomb
// Email       : gpnewcomb@live.com   
// Version     : See "Revision History" below
// Copyright   : Copyright 2014 University of Nebraska-Lincoln
// Description : Header file including function prototypes and object
//				 definitions used in uORF extraction and compilation
//==============================================================================
//
//  Revision History
//      v0.0.0 - 2014/06/05 - Garin Newcomb
//          Initial creation of file, pulling primarily from the previous "uORF_manip" used with
//			this program
//
//    	Appl Version at Last File Update::  v0.0.x - 2014/06/05 - Garin Newcomb
//      	[Note:  until program released, all files tracking with program revision level -- see "version.h" file]
//
//==============================================================================


////////////////////////////////////////////////////////////////////////////////
//
//  Table of Contents -- Header (.h) File
//      (Note: (*) indicates that the section is not present in this file)
//
//      A. Include Statements, Preprocessor Directives, and Related
//     *B. Global Variable Declarations (including those in other files)
//      C. Type (and Member Function) Declarations and Definitions
//      D. Non-Member Function Declarations
//     *E. Templated (Non-Member) Function Declarations and Definitions
//     *F. Inline (Non-Member) Function Declarations and Definitions
//      G. UNUSED Non-Member Function Declarations
//
////////////////////////////////////////////////////////////////////////////////



#ifndef UORF__COMPILE_H
#define UORF__COMPILE_H



////////////////////////////////////////////////////////////////////////////////
//
// A. Include Statements, Preprocessor Directives, and Related
//
////////////////////////////////////////////////////////////////////////////////

// Standard libraries and related
#include <string>
#include <vector>

// Project-specific header files:  definitions and related information
#include "defs__general.h"

// Project-specific header files:  support functions and related
#include "support__general.h"
#include "support__file_io.h"
#include "support__bioinformatics.h"

////////////////////////////////////////////////////////////////////////////////





////////////////////////////////////////////////////////////////////////////////
//
// C. Type (and Member Function) Declarations and Definitions
//
////////////////////////////////////////////////////////////////////////////////

//==============================================================================

// Define an enumeration for the various fields in a uORF .CSV file
// (Note:  global scope, so these values are accessible for any file that includes this header)
enum Tenum_uORF_CSV_columns
{
    // The enumeration begins at 0, so the first enumerated definition will access the first 'TCSV_field' object in 'CSV_row_fields'
    
	UORF_CSV_COL_NUM_CHROM_NUM,		
	UORF_CSV_COL_NUM_SYST_NAME,	
	UORF_CSV_COL_NUM_GENE_CONTEXT,		
	UORF_CSV_COL_NUM_GENE_AUGCAI,		
	UORF_CSV_COL_NUM_GENE_CHANGE,		
	UORF_CSV_COL_NUM_CDS_RIB_RPKM,
	UORF_CSV_COL_NUM_GO_BIO_PROC,
	UORF_CSV_COL_NUM_GO_CELL_COMP,
	UORF_CSV_COL_NUM_GO_MOL_FUNC,
	
	UORF_CSV_COL_NUM_SOURCE,
	UORF_CSV_COL_NUM_EVIDENCE_TYPE,
	UORF_CSV_COL_NUM_UORF_POS,		
	UORF_CSV_COL_NUM_UORF_LEN,		
	UORF_CSV_COL_NUM_UORF_REL_POS,	
	UORF_CSV_COL_NUM_AUGCAI,	
	UORF_CSV_COL_NUM_RIBOSOMES,	
	UORF_CSV_COL_NUM_UORF_CONTEXT,
		
	UORF_CSV_COL_NUM_PROBLEM,
	UORF_CSV_COL_NUM_UORF_IN_FRAME,		
	UORF_CSV_COL_NUM_START_CODON,	
	UORF_CSV_COL_NUM_START_MOVED,	
	UORF_CSV_COL_NUM_PAST_GENE,	
	UORF_CSV_COL_NUM_LEN_CHANGE,	
		
	UORF_CSV_COL_NUM_EXT_UORF_CONTEXT,	
	UORF_CSV_COL_NUM_EXT_GENE_CONTEXT,	
	UORF_CSV_COL_NUM_UORF,	
	
	
	NUM_CSV_UORF_COLUMNS			
};

//==============================================================================



class TData_Source
{
	private:
		std::string author;
		std::string evidence_type;
		
	public:
		std::string get_author  ( void ) const;
		std::string get_evidence( void ) const;
		
		TData_Source( const std::string & paper_author );
};
//==============================================================================



class TuORF_Data
{
	public:
		std::string content;
		std::string start_context;
		std::string ext_start_context;
		int rel_uORF_pos;
		unsigned int start_pos;
		unsigned int len;
		unsigned int exp_len;
		double AUGCAI;
		bool in_frame;
		std::vector <TData_Source> source;
		int num_ribosomes;
		
		bool problem;
		
		bool start_codon;
		int num_nt_start_moved;
		
		bool end_past_gene_start;
		int num_nt_len_changed;
		

		TuORF_Data( const std::string uORF_content,
					const std::string uORF_start_context,
					const std::string uORF_ext_start_context,
					const int relative_uORF_pos,
					const unsigned int uORF_start_pos,
					const unsigned int uORF_len,
					const unsigned int exp_uORF_len,
					const bool uORF_in_frame,
					const std::string & data_source,
					const bool start,  
					const unsigned int nt_start_moved,  
					const bool end_past_gene,
					const unsigned int num_rib = DEFAULT_NUM_RIBOSOMES  );
};
//==============================================================================



class TORF_Data
{
	private:
		std::vector <TuORF_Data> uORFs;

	public:
		std::string UTR_content;
				
		std::string gene_name;
		std::string gene_start_context;
		std::string ext_gene_start_context;
		double gene_AUGCAI;
		unsigned int chrom_num;
		unsigned int gene_start_pos;
		int gene_pos_change;
		bool opposite_strand;
		std::vector <TFeature> untrans_reg;
		TFeature fpUTR_intron;
		double CDS_rib_rpkM;
		
		vector <TGO_Annotation> GO_Annotations;
		string GO_term_to_sort_curr_level;
		vector <TGO_Term> most_specific_GO_term;

		
		std::vector <TuORF_Data> get_uORFs( void ) const;
		TuORF_Data get_uORF( unsigned int uORF_it ) const;
		void delete_uORF   ( unsigned int uORF_it );
		void add_uORF( const TuORF_Data uORF );
		
		int extract_uORF( const int exp_rel_uORF_pos,
						  const unsigned int exp_uORF_len,
						  const std::string & exp_start_codon,
						  const std::string & chrom_seq,
						  const std::string & data_source,
						  unsigned int * const num_realigned_uORFs  = NULL,
						  unsigned int * const num_misaligned_uORFs = NULL,
						  const std::string & exp_start_context = "",
						  const unsigned int num_ribosomes = DEFAULT_NUM_RIBOSOMES );
		
		void add_GO_Annotation( const std::string & name_space, const std::string & term, const std::string & evidence, const std::vector < TGO_Annotation > & All_GO_Annotations );
		void calculate_AUGCAI_values( void );
		
		void update_AUGCAI ( const unsigned int uORF_it, double new_AUGCAI  );
		void update_num_rib( const unsigned int uORF_it, double new_num_rib );
		void add_source	   ( const unsigned int uORF_it, unsigned int pos_to_add, std::string added_source );
		void update_source ( const unsigned int uORF_it, std::vector <TData_Source> data_source );
		void clear_start_pos_change( const unsigned int uORF_it );
		void clear_length_change   ( const unsigned int uORF_it );
		void clear_problem   	   ( const unsigned int uORF_it );
		void sort_uORFs( void );	
		
	
		// Comparator Functor to be used with 'sort()'
		struct compare_uORFs
		{ 
		   const TORF_Data& m_ORF_Data;

		   bool operator()( const TuORF_Data & uORF_1, const TuORF_Data & uORF_2 );
		   
		   compare_uORFs( const TORF_Data& ORF_Data ) : m_ORF_Data( ORF_Data ) { }
	    };
		
		std::vector <std::vector <std::string> > form_vector_for_csv_rows( const std::vector <Tenum_uORF_CSV_columns> & col_to_write, const bool select_uORFs ) const;
		int get_gene_start_context( const std::string & chrom_seq );


		TORF_Data( const unsigned int chr_num, 
				   const std::string gene, 
				   const unsigned int start, 
				   const int change, 
				   const bool strand, 
				   const std::vector <TFeature> untrans,
				   const TFeature fpUTR_in,
				   const double CDS_rib = DEFAULT_CDS_RIB_RPKM );
};
//==============================================================================

////////////////////////////////////////////////////////////////////////////////





////////////////////////////////////////////////////////////////////////////////
//
// D. Non-Member Function Declarations
//
////////////////////////////////////////////////////////////////////////////////

void compile_uORF_list( const TFasta_Content & S_Cerevisiae_Chrom, vector < TORF_Data > * const ORF_Data );
void compile_uORF_list_from_data( const TFasta_Content & S_Cerevisiae_Chrom, std::vector < TORF_Data > * const ORF_Data );
void add_GO_info_to_ORFs( std::vector < TORF_Data > * const ORF_Data, const std::vector < TGO_Annotation > & All_GO_Annotations );
void determine_ORF_and_uORF_characteristics( const TFasta_Content & S_Cerevisiae_Chrom, vector < TORF_Data > * const ORF_Data );

TCSV_Contents * extract_uORF_rows_from_Miura_table( void );

int extract_gene_coord_Miura( const TCSV_Contents & uORF_table, const std::vector <std::string> & gff_annotations, std::vector< TORF_Data > * const ORF_Data, unsigned int * const uORF_data_start_it );

int extract_UTR_coord_from_Miura_table_row( const std::string & UTR_coord_raw, 
											const std::string & gene_name,
											const unsigned int UTR_exp_length, 
											unsigned int * const UTR_chrom_num,    
											unsigned int * const UTR_start_pos,  
											unsigned int * const UTR_end_pos,  
											bool 		 * const opposite_strand,
											unsigned int * const UTR_length = NULL  );
									  

int extract_uORFs_Miura( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector < TORF_Data > * const ORF_Data, const unsigned int uORF_data_start_it );


int extract_gene_coord_Ingolia( const TCSV_Contents & uORF_table, 
							    const std::vector <std::string> & gff_annotations, 
							    const std::vector <std::string> & yeast_chromosomes, 
							    std::vector < TORF_Data > * const ORF_Data, 
							    unsigned int * const uORF_data_start_it );
							   
int extract_uORFs_Ingolia( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> * const ORF_Data, const unsigned int uORF_data_start_it );



int extract_gene_coord_Zhang_Dietrich( const TCSV_Contents & uORF_table, 
									   const std::vector <std::string> & gff_annotations, 
									   std::vector < TORF_Data > * const ORF_Data, 
									   unsigned int * const uORF_data_start_it );
									   
int extract_uORFs_Zhang_Dietrich_NAR( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> * const ORF_Data, const unsigned int uORF_data_start_it );
int extract_uORFs_Zhang_Dietrich_CG ( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> * const ORF_Data, const unsigned int uORF_data_start_it );
									   

int extract_gene_coord_Nagalakshmi( const TCSV_Contents & uORF_table, const std::vector <std::string> & gff_annotations,   std::vector< TORF_Data > * const ORF_Data, unsigned int * const uORF_data_start_it );
int extract_uORFs_Nagalakshmi     ( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> *  const ORF_Data, const unsigned int   uORF_data_start_it );


int extract_gene_coord_general( const TCSV_Contents & uORF_table, 
								const std::vector <std::string> & gff_annotations, 
								std::vector< TORF_Data > * const ORF_Data, 
								unsigned int * const uORF_data_start_it );
								
int extract_uORFs_Cvijovic( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> *  const ORF_Data, const unsigned int uORF_data_start_it );
int extract_uORFs_Guan    ( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> *  const ORF_Data, const unsigned int uORF_data_start_it );
int extract_uORFs_Lawless ( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> *  const ORF_Data, const unsigned int uORF_data_start_it );
int extract_uORFs_Selpi   ( const TCSV_Contents & uORF_table, const std::vector <std::string> & yeast_chromosomes, std::vector <TORF_Data> *  const ORF_Data, const unsigned int uORF_data_start_it );

								  

void realign_uORF( const std::string & chrom_seq,
				   const std::string & gene_name,
				   const bool opposite_strand,
				   const std::string & exp_start_codon,
				   const unsigned int uORF_len,
				   int * const rel_uORF_pos,
				   int * const uORF_first_coord_in_chrom_it,
				   std::string * const uORF_content,
				   int * const num_nt_start_moved,
				   bool * const start_codon_found  );

int uORF_analysis( const std::string & chrom_seq,
				   const std::string & gene_name,
				   const unsigned int gene_start_pos,
				   const bool opposite_strand,
				   const bool start_codon_found,
				   const int rel_uORF_pos,
				   int uORF_first_coord_in_chrom_it,
				   const std::vector <TFeature> untrans_reg,
				   std::string * const uORF_content,
				   std::string * const uORF_start_context,
				   std::string * const ext_uORF_start_context,
				   unsigned int * const uORF_start_pos,
				   unsigned int * const uORF_len,
				   bool * const end_past_gene_start,
				   bool * const uORF_in_frame );
									 

									 
void combine_uORFs_by_gene( std::vector < TORF_Data > * const ORF_Data );
void delete_duplicate_uORFs(  std::vector < TORF_Data > * const ORF_Data, const bool uORFs_to_delete = DELETE_ALL_DUPLICATES );

int parse_uORFs_from_list( std::vector < TORF_Data > * const ORF_Data, 
						   const std::vector <std::string> & gff_annotations, 
						   const std::vector < TGO_Annotation > & All_GO_Annotations, 
						   const bool & file_naming_method = GENERATE_FILE_NAME );

////////////////////////////////////////////////////////////////////////////////





////////////////////////////////////////////////////////////////////////////////
//
// G. UNUSED Non-Member Function Declarations
//
////////////////////////////////////////////////////////////////////////////////

// int extract_gene_coord_Miura( const TCSV_Contents & uORF_table, std::vector< TORF_Data > * const ORF_Data, const std::vector <std::string> & yeast_genbank, unsigned int * const uORF_data_start_it );
// int extract_gene_coord_Miura( const TCSV_Contents & uORF_table, std::vector< TORF_Data > * const ORF_Data, unsigned int * const uORF_data_start_it );

// int extract_UTRs( const std::vector <std::string> yeast_chromosomes, std::vector < TUORF_Data > * const uORF_Data, const unsigned int uORF_data_start_it );

////////////////////////////////////////////////////////////////////////////////



#endif // UORF__COMPILE_H


